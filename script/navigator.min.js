$(document).ready(function() {
	$.ajax({
		type: 'GET',
		url: '/etc/menu.xml',
		success: function(data) {
			$(data).find('section').each(function() {
				var header = $(this).children('header').text();
				$('#sideMenu').append($('<div></div>').css('font-size', '1.6em').html(header));
				$('.navbar-side').append($('<div></div>').css('font-size', '1.6em').html(header));

				$(this).children('menu').each(function() {
					var link = $(this).children('link').text();
					var label = $(this).children('label').text();
					if (window.location.pathname != "/" + link + "/") {
						$('#sideMenu').append($.createAnchor(label, "/" + link, []));
						$('.navbar-side').append($.createAnchor(label, "/" + link, ["navbar-side-item"]));
					} else {
						var uList = $('<ul></ul>').addClass('nav').addClass('nav-stacked');

						$(this).children('submenu').each(function() {
							var sublink = $(this).children('link').text();
							var sublabel = $(this).children('label').text();
							uList.append($.createAnchor(sublabel, sublink, []));
						});

						$('#sideMenu').append(
							$.createAnchor(label, null, ["active"]).append(
								$('<div></div>').attr('id', 'scrollspy').append(uList)
							)
						);
						$('.navbar-side').append($.createAnchor(label, null, ["active", "navbar-side-item"]));
					}
				});
			});

			$('[data-spy=scroll]').each(function() {
				$(this).scrollspy('refresh');
			});
		}
	});

	var affixOffsetTop = function() {
		var top = $("#topBanner").outerHeight(true) - $(".navbar-fixed-top").outerHeight(true);
		if (top > 0) {
			return top;
		}
		return 0;
	}

	var affixOffsetBottom = function() {
		return $(".navbar-fixed-top").outerHeight(true) + $(".navbar-bottom").outerHeight(true) + $(".hire-button").height();
	}

	$("#sideMenu").affix({
		offset: {
			top: affixOffsetTop, bottom: affixOffsetBottom
		}
	});
});

$.createAnchor = function (label, link, option) {
	var anchor = $('<a>' + label + '</a>');
	var list = $('<li></li>').append(anchor);

	if (link != null) {
		anchor.attr('href', link);
	}

	$.each(option, function(index, value) {
		list.addClass(value);
	});

	return list;
}